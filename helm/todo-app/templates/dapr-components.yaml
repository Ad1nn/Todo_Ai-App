{{/*
=============================================================================
dapr-components.yaml - Dapr Components for Event-Driven Architecture
=============================================================================

LEARNING NOTES:
- These components are deployed when Dapr is enabled
- Pub/Sub component connects to Kafka/Redpanda for event messaging
- Cron binding triggers periodic reminder checks
- Subscriptions route events to specific endpoints

=============================================================================
*/}}

{{- if .Values.dapr.enabled }}
---
# Pub/Sub Component - Kafka/Redpanda
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: {{ .Values.dapr.pubsub.name }}
  namespace: {{ .Release.Namespace }}
spec:
  type: {{ .Values.dapr.pubsub.type }}
  version: v1
  metadata:
    - name: brokers
      value: {{ .Values.dapr.pubsub.brokers | quote }}
    - name: consumerGroup
      value: {{ .Values.dapr.pubsub.consumerGroup | quote }}
    - name: authRequired
      value: "false"
    - name: maxMessageBytes
      value: "1048576"  # 1MB
    - name: consumeRetryInterval
      value: "100ms"

---
# Cron Binding - Reminder Check Scheduler
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: reminder-cron
  namespace: {{ .Release.Namespace }}
spec:
  type: bindings.cron
  version: v1
  metadata:
    - name: schedule
      value: "*/15 * * * *"  # Every 15 minutes
    - name: direction
      value: "input"

---
# Subscription - Reminder Events
apiVersion: dapr.io/v2alpha1
kind: Subscription
metadata:
  name: reminder-subscription
  namespace: {{ .Release.Namespace }}
spec:
  pubsubname: {{ .Values.dapr.pubsub.name }}
  topic: todo.reminders
  route: /events/reminders
  scopes:
    - {{ .Values.backend.dapr.appId }}

---
# Subscription - Audit Events
apiVersion: dapr.io/v2alpha1
kind: Subscription
metadata:
  name: audit-subscription
  namespace: {{ .Release.Namespace }}
spec:
  pubsubname: {{ .Values.dapr.pubsub.name }}
  topic: todo.audit
  route: /events/audit
  scopes:
    - {{ .Values.backend.dapr.appId }}
{{- end }}
