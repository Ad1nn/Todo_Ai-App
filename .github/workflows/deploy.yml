# =============================================================================
# Deploy Workflow - Continuous Deployment to DigitalOcean DOKS
# =============================================================================
#
# Triggers on: Push to main (production), Push to develop (staging)
# Jobs:
#   - Build and push Docker images
#   - Deploy to Kubernetes via Helm
#
# Required Secrets:
#   - DIGITALOCEAN_ACCESS_TOKEN: DO API token
#   - CLUSTER_NAME: DOKS cluster name
#   - DATABASE_URL: Neon PostgreSQL connection string
#   - JWT_SECRET: JWT signing secret
#   - OPENAI_API_KEY: OpenAI API key
#
# =============================================================================

name: Deploy

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: registry.digitalocean.com
  REGISTRY_NAME: todo-registry

jobs:
  # ---------------------------------------------------------------------------
  # Determine Environment
  # ---------------------------------------------------------------------------
  setup:
    name: Setup Deployment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      namespace: ${{ steps.set-env.outputs.namespace }}
      values-file: ${{ steps.set-env.outputs.values-file }}

    steps:
      - name: Determine environment
        id: set-env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ENV="production"
          else
            ENV="staging"
          fi

          echo "environment=${ENV}" >> $GITHUB_OUTPUT
          echo "namespace=todo-app-${ENV}" >> $GITHUB_OUTPUT
          echo "values-file=values-${ENV}.yaml" >> $GITHUB_OUTPUT
          echo "Deploying to: ${ENV}"

  # ---------------------------------------------------------------------------
  # Build and Push Docker Images
  # ---------------------------------------------------------------------------
  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Login to DigitalOcean Container Registry
        run: doctl registry login --expiry-seconds 600

      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAME }}/todo-backend:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAME }}/todo-backend:${{ needs.setup.outputs.environment }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAME }}/todo-frontend:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAME }}/todo-frontend:${{ needs.setup.outputs.environment }}
          build-args: |
            NEXT_PUBLIC_API_URL=${{ needs.setup.outputs.environment == 'production' && 'https://api.todo-app.example.com' || 'https://staging-api.todo-app.example.com' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ---------------------------------------------------------------------------
  # Deploy to Kubernetes
  # ---------------------------------------------------------------------------
  deploy:
    name: Deploy to DOKS
    runs-on: ubuntu-latest
    needs: [setup, build-and-push]
    environment: ${{ needs.setup.outputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Configure kubectl
        run: |
          doctl kubernetes cluster kubeconfig save ${{ secrets.CLUSTER_NAME }}

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: "3.14.0"

      - name: Create namespace if not exists
        run: |
          kubectl create namespace ${{ needs.setup.outputs.namespace }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy with Helm
        run: |
          helm upgrade --install todo-app ./helm/todo-app \
            --namespace ${{ needs.setup.outputs.namespace }} \
            --values ./helm/todo-app/${{ needs.setup.outputs.values-file }} \
            --set backend.image.tag=${{ github.sha }} \
            --set frontend.image.tag=${{ github.sha }} \
            --set secrets.databaseUrl=${{ secrets.DATABASE_URL }} \
            --set secrets.jwtSecret=${{ secrets.JWT_SECRET }} \
            --set secrets.openaiApiKey=${{ secrets.OPENAI_API_KEY }} \
            --wait \
            --timeout 10m

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/todo-app-backend -n ${{ needs.setup.outputs.namespace }}
          kubectl rollout status deployment/todo-app-frontend -n ${{ needs.setup.outputs.namespace }}

      - name: Get deployment info
        run: |
          echo "=== Pods ==="
          kubectl get pods -n ${{ needs.setup.outputs.namespace }}
          echo ""
          echo "=== Services ==="
          kubectl get svc -n ${{ needs.setup.outputs.namespace }}
          echo ""
          echo "=== Ingress ==="
          kubectl get ingress -n ${{ needs.setup.outputs.namespace }}

  # ---------------------------------------------------------------------------
  # Post-Deploy Health Check
  # ---------------------------------------------------------------------------
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [setup, deploy]

    steps:
      - name: Wait for deployment to stabilize
        run: sleep 30

      - name: Check backend health
        run: |
          BACKEND_URL="${{ needs.setup.outputs.environment == 'production' && 'https://api.todo-app.example.com' || 'https://staging-api.todo-app.example.com' }}"
          for i in {1..5}; do
            if curl -sf "${BACKEND_URL}/health"; then
              echo "Backend is healthy!"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 10
          done
          echo "Health check failed after 5 attempts"
          exit 1

      - name: Check frontend health
        run: |
          FRONTEND_URL="${{ needs.setup.outputs.environment == 'production' && 'https://todo-app.example.com' || 'https://staging.todo-app.example.com' }}"
          for i in {1..5}; do
            if curl -sf "${FRONTEND_URL}" > /dev/null; then
              echo "Frontend is healthy!"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 10
          done
          echo "Health check failed after 5 attempts"
          exit 1

  # ---------------------------------------------------------------------------
  # Notify on Failure
  # ---------------------------------------------------------------------------
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [deploy, health-check]
    if: failure()

    steps:
      - name: Create failure summary
        run: |
          echo "## Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
